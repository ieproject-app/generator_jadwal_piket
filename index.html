<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Penjadwalan Regu Jaga</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    /* Scrollbar and sticky fix for print/screenshot */
    .sticky-header {
      position: sticky;
      top: 0;
      background: #f8fafc;
      z-index: 2;
    }
    .sticky-month {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #e0e7ef;
    }
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
    }
    th, td { font-size: 13px !important; padding: 2px 6px !important; }
    table { border-collapse: collapse; }
    thead th { border-bottom: 1px solid #cbd5e1; }
    td, th { border: 1px solid #e5e7eb; }
    .holiday-row { background: #f3f4f6 !important; color: #888 !important; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700">

  <!-- Header -->
  <div class="w-full bg-white shadow-sm p-3 mb-4 sticky top-0 z-10">
    <h1 class="text-xl font-semibold text-center">Penjadwalan Regu Jaga (Client-side)</h1>
  </div>

  <!-- Main Container -->
  <div id="main-content" class="max-w-6xl mx-auto px-2">
    <form id="configForm" class="bg-white rounded-md shadow p-4 mb-6">
      <div class="grid md:grid-cols-3 gap-4">

        <!-- Tanggal Mulai/Selesai -->
        <div>
          <label class="block text-sm mb-1 font-medium">Tanggal Mulai</label>
          <input type="date" id="startDate" required class="border rounded w-full p-1 text-sm"/>
          <label class="block mt-3 text-sm mb-1 font-medium">Tanggal Selesai</label>
          <input type="date" id="endDate" required class="border rounded w-full p-1 text-sm"/>
        </div>

        <!-- Daftar Regu -->
        <div>
          <label class="block text-sm mb-1 font-medium">Daftar Regu (satu per baris)</label>
          <textarea id="groupList" rows="7" required class="border rounded w-full p-1 text-sm resize-none"></textarea>
          <div class="flex items-center gap-2 mt-2">
            <input type="file" id="importTxt" accept=".txt" class="hidden"/>
            <button type="button" id="importBtn" class="px-2 py-1 text-xs bg-slate-200 rounded hover:bg-slate-300">Import TXT</button>
            <span id="importStat" class="text-xs text-green-600"></span>
          </div>
        </div>

        <!-- Hari Libur & Opsi Urutan -->
        <div>
          <label class="block text-sm mb-1 font-medium">Hari Libur (multi-date)</label>
          <div id="holidayPicker" class="flex flex-wrap gap-1 mb-2"></div>
          <input type="date" id="holidayInput" class="border rounded p-1 text-sm"/>
          <button type="button" id="addHolidayBtn" class="ml-1 px-2 py-1 text-xs bg-slate-200 rounded hover:bg-slate-300">Tambah</button>
          <div class="mt-4">
            <label class="block text-sm mb-1 font-medium">Opsi Urutan Regu</label>
            <div class="flex gap-4 mt-1">
              <label class="flex items-center gap-1 text-sm"><input type="radio" name="orderType" value="shuffle" checked/> Acak per siklus</label>
              <label class="flex items-center gap-1 text-sm"><input type="radio" name="orderType" value="manual"/> Manual (urutan tetap)</label>
            </div>
          </div>
        </div>
      </div>

      <div class="flex gap-2 mt-6 justify-end">
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Generate</button>
        <button type="button" id="resetBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300">Reset</button>
      </div>
    </form>

    <!-- Export & Print Buttons -->
    <div id="exportBar" class="mb-3 flex gap-2 no-print" style="display:none">
      <button id="downloadXLSX" class="px-3 py-2 text-xs bg-green-600 text-white rounded hover:bg-green-700">Download XLSX</button>
      <button id="downloadCSV" class="px-3 py-2 text-xs bg-sky-600 text-white rounded hover:bg-sky-700">Download CSV</button>
      <button onclick="window.print()" class="px-3 py-2 text-xs bg-slate-400 text-white rounded hover:bg-slate-500">Print</button>
    </div>

    <!-- Jadwal Output -->
    <div id="scheduleOut" class="overflow-x-auto"></div>
  </div>

<script>
/* ==== STATE ==== */
let holidays = [];

/* ==== Hari Libur Picker ==== */
function renderHolidayPicker() {
  const container = document.getElementById('holidayPicker');
  container.innerHTML = '';
  holidays.sort();
  holidays.forEach((d, idx) => {
    const badge = document.createElement('span');
    badge.className = 'bg-slate-300 text-xs rounded px-2 py-1 mr-1 mb-1 cursor-pointer hover:bg-red-400';
    badge.innerText = formatTanggal(d);
    badge.title = 'Klik untuk hapus';
    badge.onclick = () => { holidays.splice(idx,1); renderHolidayPicker(); };
    container.appendChild(badge);
  });
}
document.getElementById('addHolidayBtn').onclick = function() {
  const val = document.getElementById('holidayInput').value;
  if (val && !holidays.includes(val)) {
    holidays.push(val);
    renderHolidayPicker();
    document.getElementById('holidayInput').value = '';
  }
};

/* ==== Import TXT ==== */
document.getElementById('importBtn').onclick = () => document.getElementById('importTxt').click();
document.getElementById('importTxt').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const lines = ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    document.getElementById('groupList').value = lines.join('\n');
    document.getElementById('importStat').innerText = 'Berhasil diimport!';
    setTimeout(()=>{document.getElementById('importStat').innerText='';}, 2000);
  };
  reader.readAsText(file);
};

/* ==== Reset ==== */
document.getElementById('resetBtn').onclick = function() {
  document.getElementById('configForm').reset();
  document.getElementById('groupList').value = '';
  holidays = [];
  renderHolidayPicker();
  document.getElementById('scheduleOut').innerHTML = '';
  document.getElementById('exportBar').style.display = 'none';
};

/* ==== Generate ==== */
document.getElementById('configForm').onsubmit = function(e) {
  e.preventDefault();

  // Ambil input
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  let groups = document.getElementById('groupList').value.split('\n').map(g=>g.trim()).filter(Boolean);
  const orderType = document.querySelector('input[name="orderType"]:checked').value;
  if (groups.length < 2) {
    alert('Minimal 2 regu diperlukan');
    return;
  }
  if (!startDate || !endDate || startDate > endDate) {
    alert('Tanggal mulai/selesai tidak valid');
    return;
  }
  // Generate jadwal
  const jadwal = generateSchedule(startDate, endDate, holidays, groups, orderType);
  renderScheduleTable(jadwal);
  document.getElementById('exportBar').style.display = '';
};

/* ==== Jadwal Generator ==== */
function shuffleArray(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function generateSchedule(start, end, holidaysList, groupList, orderType) {
  // Buat daftar tanggal valid (exclude libur)
  let days = [];
  let cur = new Date(start);
  const endDate = new Date(end);
  holidaysList = holidaysList.slice();
  while (cur <= endDate) {
    const iso = cur.toISOString().slice(0,10);
    days.push({date: iso, isHoliday: holidaysList.includes(iso)});
    cur.setDate(cur.getDate()+1);
  }
  // Penjadwalan
  let schedule = [];
  let pool = groupList.slice();
  let idx = 0, last1=null, last2=null;

  for (let d of days) {
    if (d.isHoliday) {
      schedule.push({date: d.date, group1: 'Libur', group2: 'Libur', isHoliday:true});
      continue;
    }
    let g1, g2;
    if (orderType === 'manual') {
      g1 = pool[idx % pool.length];
      g2 = pool[(idx+1)%pool.length];
      // Cegah duplikat berurutan
      if (g1===last1 || g2===last2 || g1===last2 || g2===last1) {
        idx++;
        g1 = pool[idx % pool.length];
        g2 = pool[(idx+1)%pool.length];
      }
      idx++;
    } else { // shuffle per siklus
      if (idx===0 || idx>=pool.length-1) {
        pool = shuffleArray(pool);
        // Pastikan reshuffle tidak menyebabkan duplikat dengan hari sebelumnya
        if (last1 && (pool[0]===last1 || pool[1]===last2)) {
          pool = shuffleArray(pool);
        }
        idx = 0;
      }
      g1 = pool[idx];
      g2 = pool[idx+1];
      // Cegah duplikat berurutan
      if (g1===last1 || g2===last2 || g1===last2 || g2===last1) {
        idx++;
        if (idx>=pool.length-1) {
          pool = shuffleArray(pool);
          idx = 0;
        }
        g1 = pool[idx];
        g2 = pool[idx+1];
      }
      idx++;
    }
    last1=g1; last2=g2;
    schedule.push({date: d.date, group1: g1, group2: g2, isHoliday:false});
  }
  return schedule;
}

/* ==== Format Hari Indonesia ==== */
function formatTanggal(iso) {
  const hari = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d = new Date(iso);
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function formatBulanTahun(iso) {
  const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d = new Date(iso);
  return `${bulan[d.getMonth()]} ${d.getFullYear()}`;
}

/* ==== Render Schedule Table ==== */
function groupByMonth(jadwal) {
  let map = {};
  jadwal.forEach(row => {
    let ym = row.date.slice(0,7);
    if (!map[ym]) map[ym]=[];
    map[ym].push(row);
  });
  return map;
}
function renderScheduleTable(jadwal) {
  const byMonth = groupByMonth(jadwal);
  let html = '<div class="flex flex-wrap gap-6">';
  for (let ym in byMonth) {
    const rows = byMonth[ym];
    const monthTitle = formatBulanTahun(rows[0].date);
    // Panel per bulan
    html += `<div class="min-w-[340px] bg-white rounded shadow p-2 pb-4 flex-1">
      <div class="sticky-month top-0 z-10 text-base font-semibold mb-2 text-center">${monthTitle}</div>
      <div class="overflow-x-auto">
      <table class="w-full text-xs">
        <thead class="sticky-header">
          <tr>
            <th rowspan="2" class="sticky-header">Tanggal</th>
            <th colspan="2" class="sticky-header">Kelompok Jaga</th>
          </tr>
          <tr>
            <th class="sticky-header">Grup 1</th>
            <th class="sticky-header">Grup 2</th>
          </tr>
        </thead>
        <tbody>`;
    // 15 baris per kolom, kolom lanjut di panel yang sama
    let colCnt = Math.ceil(rows.length/15);
    for (let col=0; col<colCnt; col++) {
      let start = col*15, end = Math.min(rows.length, (col+1)*15);
      if (col>0) html += `<tr><td colspan="3" class="h-2"></td></tr>`; // spasi antar kolom
      for (let i=start; i<end; i++) {
        const row = rows[i];
        html += `<tr class="${row.isHoliday?'holiday-row':''}">
          <td>${formatTanggal(row.date)}</td>
          <td>${row.group1}</td>
          <td>${row.group2}</td>
        </tr>`;
      }
    }
    html += '</tbody></table></div></div>';
  }
  html += '</div>';
  document.getElementById('scheduleOut').innerHTML = html;
}

/* ==== EXPORT XLSX/CSV ==== */
function getScheduleDataForExport() {
  // Flat array: [Tanggal, Grup 1, Grup 2]
  const tables = document.querySelectorAll('#scheduleOut table');
  if (!tables.length) return [];
  let data = [];
  tables.forEach(tb=>{
    const month = tb.closest('div').querySelector('.sticky-month')?.innerText || '';
    const rows = tb.querySelectorAll('tbody tr');
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      if (tds.length===3) {
        data.push([month, tds[0].innerText, tds[1].innerText, tds[2].innerText]);
      }
    });
  });
  return data;
}
document.getElementById('downloadXLSX').onclick = function() {
  const rows = getScheduleDataForExport();
  if (!rows.length) return;
  const ws = XLSX.utils.aoa_to_sheet([['Bulan','Tanggal','Grup 1','Grup 2'], ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Jadwal');
  XLSX.writeFile(wb, 'jadwal_regu.xlsx');
};
document.getElementById('downloadCSV').onclick = function() {
  const rows = getScheduleDataForExport();
  if (!rows.length) return;
  let csv = 'Bulan,Tanggal,Grup 1,Grup 2\n'+rows.map(r=>r.map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'jadwal_regu.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
