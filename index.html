<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Jadwal Regu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        accent: '#10b981',
                        dark: '#1f2937',
                        light: '#f9fafb'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        .header-gradient {
            background: linear-gradient(90deg, #1e40af 0%, #3b82f6 100%);
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .month-header {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            position: sticky;
            top: 3.5rem;
            z-index: 40;
        }
        
        .holiday-cell {
            background-color: #e5e7eb;
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none;
            }
            .print-only {
                display: block;
            }
            body {
                background: white;
                padding: 0;
            }
            .schedule-table {
                box-shadow: none;
                border: 1px solid #e5e7eb;
            }
        }
        
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <header class="header-gradient text-white py-6 rounded-b-2xl shadow-lg mb-8">
            <div class="text-center">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">Generator Jadwal Regu</h1>
                <p class="text-blue-100 max-w-2xl mx-auto">Buat jadwal penugasan regu secara otomatis dengan konfigurasi fleksibel</p>
            </div>
        </header>

        <!-- Konfigurasi -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Konfigurasi Jadwal</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 config-grid">
                <!-- Rentang Tanggal -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Rentang Tanggal</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Tanggal Mulai</label>
                            <input type="date" id="startDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Tanggal Selesai</label>
                            <input type="date" id="endDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>
                </div>
                
                <!-- Daftar Regu -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Daftar Regu</label>
                    <textarea id="teamsInput" rows="4" placeholder="Masukkan daftar regu, satu per baris&#10;Contoh:&#10;Regu A&#10;Regu B&#10;Regu C" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent mb-2"></textarea>
                    <div class="flex gap-2">
                        <button id="importCsvBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition">
                            Import CSV
                        </button>
                        <button id="importJsonBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition">
                            Import JSON
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept=".csv,.json">
                    </div>
                </div>
                
                <!-- Hari Libur -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Hari Libur</label>
                    <div class="flex gap-2 mb-2">
                        <input type="date" id="holidayDate" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <button id="addHolidayBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition">
                            Tambah
                        </button>
                    </div>
                    <div id="holidaysList" class="bg-gray-50 p-3 rounded-lg max-h-32 overflow-y-auto">
                        <p class="text-gray-500 text-sm italic">Belum ada hari libur ditambahkan</p>
                    </div>
                </div>
                
                <!-- Pengaturan -->
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Pengaturan Jadwal</label>
                    
                    <div class="mb-4">
                        <label class="block text-sm text-gray-600 mb-1">Urutan Penugasan</label>
                        <select id="orderOption" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="sequential">Berurutan (Loop Reguler)</option>
                            <option value="random">Acak</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Selisih antara Grup 1 dan Grup 2</label>
                        <input type="number" id="offsetValue" min="1" value="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button id="generateBtn" class="flex-1 bg-primary hover:bg-secondary text-white font-medium py-3 px-6 rounded-lg shadow-md transition transform hover:scale-105">
                    Generate Jadwal
                </button>
                <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg transition">
                    Reset
                </button>
            </div>
        </div>

        <!-- Jadwal -->
        <div id="scheduleSection" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Jadwal Penugasan Regu</h2>
                <div class="flex gap-2">
                    <button id="exportAllBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Export PNG
                    </button>
                    <button id="printBtn" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-lg transition flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v2a2 2 0 002 2h6a2 2 0 002-2v-2h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" />
                        </svg>
                        Cetak
                    </button>
                </div>
            </div>
            
            <div id="scheduleContainer"></div>
        </div>

        <!-- Instruksi Deploy -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Instruksi Deploy ke GitHub Pages</h2>
            <div class="bg-gray-50 p-4 rounded-lg">
                <ol class="list-decimal pl-5 space-y-2">
                    <li>Buat repository baru di GitHub</li>
                    <li>Unggah file HTML ini ke repository</li>
                    <li>Masuk ke Settings > Pages</li>
                    <li>Pada bagian "Source", pilih branch <code class="bg-gray-200 px-1 rounded">main</code> atau <code class="bg-gray-200 px-1 rounded">master</code></li>
                    <li>Pilih folder <code class="bg-gray-200 px-1 rounded">/(root)</code></li>
                    <li>Klik Save</li>
                    <li>Tunggu beberapa menit hingga aplikasi Anda online di <code class="bg-gray-200 px-1 rounded">https://[username].github.io/[repository]</code></li>
                </ol>
                <p class="mt-4 text-sm text-gray-600">Catatan: Pastikan nama file adalah <code class="bg-gray-200 px-1 rounded">index.html</code> agar GitHub Pages dapat mengenalinya sebagai halaman utama.</p>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            moment.locale('id');
            
            // Set tanggal default
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(today.getMonth() + 1);
            
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = nextMonth;
            
            // Event listeners
            document.getElementById('generateBtn').addEventListener('click', generateSchedule);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('addHolidayBtn').addEventListener('click', addHoliday);
            document.getElementById('importCsvBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('importJsonBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileImport);
            document.getElementById('exportAllBtn').addEventListener('click', exportAllAsImage);
            document.getElementById('printBtn').addEventListener('click', printSchedule);
        });

        // Fungsi untuk menambah hari libur
        function addHoliday() {
            const holidayDate = document.getElementById('holidayDate').value;
            if (!holidayDate) return;
            
            const holidaysList = document.getElementById('holidaysList');
            const formattedDate = moment(holidayDate).format('dddd, D MMMM YYYY');
            
            // Cek apakah tanggal sudah ada
            const existingDates = Array.from(holidaysList.querySelectorAll('.holiday-item')).map(el => el.dataset.date);
            if (existingDates.includes(holidayDate)) return;
            
            // Tambahkan ke daftar
            const holidayItem = document.createElement('div');
            holidayItem.className = 'holiday-item flex justify-between items-center bg-white p-2 rounded mb-2 border border-gray-200';
            holidayItem.dataset.date = holidayDate;
            
            holidayItem.innerHTML = `
                <span>${formattedDate}</span>
                <button class="text-red-500 hover:text-red-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;
            
            // Hapus placeholder jika ada
            if (holidaysList.querySelector('p')) {
                holidaysList.innerHTML = '';
            }
            
            holidaysList.appendChild(holidayItem);
            
            // Tambahkan event listener untuk tombol hapus
            holidayItem.querySelector('button').addEventListener('click', function() {
                holidayItem.remove();
                if (holidaysList.children.length === 0) {
                    holidaysList.innerHTML = '<p class="text-gray-500 text-sm italic">Belum ada hari libur ditambahkan</p>';
                }
            });
            
            // Reset input
            document.getElementById('holidayDate').value = '';
        }

        // Fungsi untuk import file
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (extension === 'csv') {
                    importCsv(content);
                } else if (extension === 'json') {
                    importJson(content);
                }
            };
            
            reader.readAsText(file);
        }

        // Import CSV
        function importCsv(csv) {
            const lines = csv.split('\n');
            const teams = lines
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => line.split(',')[0].trim()); // Ambil kolom pertama saja
            
            document.getElementById('teamsInput').value = teams.join('\n');
        }

        // Import JSON
        function importJson(json) {
            try {
                const data = JSON.parse(json);
                let teams = [];
                
                if (Array.isArray(data)) {
                    teams = data.map(item => item.toString());
                } else if (typeof data === 'object') {
                    teams = Object.values(data).map(item => item.toString());
                }
                
                document.getElementById('teamsInput').value = teams.join('\n');
            } catch (e) {
                alert('Format JSON tidak valid');
            }
        }

        // Fungsi utama untuk generate jadwal
        function generateSchedule() {
            // Validasi input
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const teamsInput = document.getElementById('teamsInput').value.trim();
            
            if (!startDate || !endDate) {
                alert('Harap masukkan rentang tanggal');
                return;
            }
            
            if (!teamsInput) {
                alert('Harap masukkan daftar regu');
                return;
            }
            
            // Dapatkan konfigurasi
            const teams = teamsInput.split('\n').map(team => team.trim()).filter(team => team);
            const orderOption = document.getElementById('orderOption').value;
            const offset = parseInt(document.getElementById('offsetValue').value) || 1;
            
            // Dapatkan hari libur
            const holidayItems = Array.from(document.getElementById('holidaysList').querySelectorAll('.holiday-item'));
            const holidays = holidayItems.map(item => item.dataset.date);
            
            // Proses penjadwalan
            const schedule = [];
            let currentDate = moment(startDate);
            const endMoment = moment(endDate);
            const teamCount = teams.length;
            
            // Acak urutan tim jika diperlukan
            let orderedTeams = [...teams];
            if (orderOption === 'random') {
                orderedTeams = teams.sort(() => Math.random() - 0.5);
            }
            
            let currentIndex = 0;
            
            while (currentDate.isSameOrBefore(endMoment)) {
                const dateStr = currentDate.format('YYYY-MM-DD');
                const isHoliday = holidays.includes(dateStr);
                
                // Tentukan grup
                let group1 = '';
                let group2 = '';
                
                if (!isHoliday && teamCount > 0) {
                    group1 = orderedTeams[currentIndex % teamCount];
                    group2 = orderedTeams[(currentIndex + offset) % teamCount];
                    currentIndex++;
                }
                
                schedule.push({
                    date: dateStr,
                    displayDate: currentDate.format('dddd, D MMMM YYYY'),
                    group1: isHoliday ? 'Libur' : group1,
                    group2: isHoliday ? 'Libur' : group2,
                    isHoliday: isHoliday,
                    monthYear: currentDate.format('MMMM YYYY')
                });
                
                currentDate.add(1, 'days');
            }
            
            // Render jadwal
            renderSchedule(schedule);
            document.getElementById('scheduleSection').classList.remove('hidden');
        }

        // Render jadwal ke tabel
        function renderSchedule(schedule) {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            // Kelompokkan berdasarkan bulan
            const groupedByMonth = {};
            schedule.forEach(day => {
                if (!groupedByMonth[day.monthYear]) {
                    groupedByMonth[day.monthYear] = [];
                }
                groupedByMonth[day.monthYear].push(day);
            });
            
            // Buat tabel untuk setiap bulan
            for (const monthYear in groupedByMonth) {
                const monthSchedule = groupedByMonth[monthYear];
                
                const table = document.createElement('div');
                table.className = 'schedule-table overflow-hidden rounded-lg shadow-md mb-8 print:shadow-none print:mb-6';
                table.id = `table-${monthYear.replace(' ', '-')}`;
                
                table.innerHTML = `
                    <div class="month-header text-white font-bold text-lg py-3 px-4">
                        ${monthYear}
                    </div>
                    <table class="w-full border-collapse">
                        <thead class="sticky-header bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 text-left">Tanggal</th>
                                <th colspan="2" class="p-3 text-center">Kelompok Jaga</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th class="p-3 border-l border-gray-200">Grup 1</th>
                                <th class="p-3 border-l border-gray-200">Grup 2</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthSchedule.map(day => `
                                <tr class="${day.isHoliday ? 'bg-gray-100' : 'even:bg-gray-50 hover:bg-blue-50'}">
                                    <td class="p-3 border-t border-gray-200 font-medium">${day.displayDate}</td>
                                    <td class="p-3 border-t border-l border-gray-200 ${day.isHoliday ? 'holiday-cell text-gray-500' : ''}">${day.group1}</td>
                                    <td class="p-3 border-t border-l border-gray-200 ${day.isHoliday ? 'holiday-cell text-gray-500' : ''}">${day.group2}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.appendChild(table);
            }
            
            // Tambahkan tombol export per bulan
            if (Object.keys(groupedByMonth).length > 1) {
                const exportMonthDiv = document.createElement('div');
                exportMonthDiv.className = 'flex flex-wrap gap-2 mb-6 no-print';
                
                exportMonthDiv.innerHTML = `
                    <span class="self-center text-gray-700">Export per bulan:</span>
                `;
                
                for (const monthYear in groupedByMonth) {
                    const button = document.createElement('button');
                    button.className = 'bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition flex items-center gap-1';
                    button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        ${monthYear}
                    `;
                    
                    button.addEventListener('click', () => {
                        exportMonthAsImage(monthYear);
                    });
                    
                    exportMonthDiv.appendChild(button);
                }
                
                container.insertBefore(exportMonthDiv, container.firstChild);
            }
        }

        // Export seluruh jadwal sebagai gambar
        function exportAllAsImage() {
            const container = document.getElementById('scheduleContainer');
            html2canvas(container, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `jadwal-regu-${moment().format('YYYY-MM-DD')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // Export per bulan sebagai gambar
        function exportMonthAsImage(monthYear) {
            const tableId = `table-${monthYear.replace(' ', '-')}`;
            const tableElement = document.getElementById(tableId);
            
            if (!tableElement) return;
            
            html2canvas(tableElement, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `jadwal-regu-${monthYear.replace(' ', '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // Cetak jadwal
        function printSchedule() {
            window.print();
        }

        // Reset form
        function resetForm() {
            document.getElementById('startDate').valueAsDate = new Date();
            
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            document.getElementById('endDate').valueAsDate = nextMonth;
            
            document.getElementById('teamsInput').value = '';
            document.getElementById('holidayDate').value = '';
            document.getElementById('holidaysList').innerHTML = '<p class="text-gray-500 text-sm italic">Belum ada hari libur ditambahkan</p>';
            document.getElementById('orderOption').value = 'sequential';
            document.getElementById('offsetValue').value = '1';
            
            document.getElementById('scheduleSection').classList.add('hidden');
        }
    </script>
</body>
</html>
