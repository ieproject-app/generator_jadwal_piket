<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Penjadwalan Kelompok Jaga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    /* Sticky header styling */
    .sticky-top { position: sticky; top: 0; z-index: 10; background: #fff; }
    .sticky-month { position: sticky; top: 0; z-index: 20; background: #f1f5f9; }
    /* Compact for screenshot */
    table,th,td { font-size: 0.95rem; }
    th, td { padding: 0.25rem 0.5rem; }
    /* Table for print */
    @media print {
      .no-print { display: none !important; }
      html, body { background: #fff !important; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-4">
  <!-- Form Panel -->
  <div id="config-panel" class="w-full max-w-3xl bg-white rounded shadow p-4 mb-4 no-print">
    <h1 class="text-xl font-bold mb-2">Penjadwalan Kelompok Jaga</h1>
    <form id="schedule-form" autocomplete="off" class="space-y-3">
      <div class="flex flex-wrap gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Tanggal Mulai</label>
          <input type="date" id="tanggal-mulai" required class="border rounded px-2 py-1 w-full">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Tanggal Selesai</label>
          <input type="date" id="tanggal-selesai" required class="border rounded px-2 py-1 w-full">
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Daftar Regu (satu per baris)</label>
        <textarea id="daftar-regu" rows="3" required class="border rounded px-2 py-1 w-full resize-none"></textarea>
        <div class="flex items-center gap-2 mt-1">
          <input type="file" id="import-txt" accept=".txt" class="hidden">
          <button type="button" id="btn-import" class="text-xs px-2 py-1 border rounded bg-gray-100 hover:bg-gray-200">Import TXT</button>
          <span id="import-label" class="text-xs text-gray-500"></span>
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Hari Libur (multi-date)</label>
        <input type="text" id="libur-picker" readonly placeholder="Pilih tanggal" class="border rounded px-2 py-1 w-full bg-white cursor-pointer" style="background:#fff!important;">
        <div id="libur-list" class="flex flex-wrap gap-2 mt-1"></div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Opsi Urutan</label>
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-1">
            <input type="radio" name="urutan" value="acak" checked>
            <span>Acak (shuffle per siklus, tidak berurutan sama)</span>
          </label>
          <label class="flex items-center gap-1">
            <input type="radio" name="urutan" value="manual">
            <span>Manual (urutan sesuai input)</span>
          </label>
        </div>
      </div>
      <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700">Generate</button>
    </form>
  </div>

  <!-- Output Panel -->
  <div id="output-panel" class="w-full max-w-[96vw] hidden flex-col items-center">
    <div class="flex flex-wrap justify-between mb-2 gap-2 no-print">
      <div class="flex gap-2">
        <button id="btn-xlsx" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">Download XLSX</button>
        <button id="btn-csv" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">Download CSV</button>
        <button id="btn-print" class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-900 text-sm">Print</button>
      </div>
      <button id="btn-reset" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-semibold">Reset</button>
    </div>
    <div id="jadwal-tabel" class="w-full flex flex-wrap gap-4 justify-center"></div>
  </div>

  <!-- Multi-date picker modal -->
  <div id="modal-libur" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded p-4 min-w-[320px]">
      <h2 class="text-lg font-bold mb-2">Pilih Hari Libur</h2>
      <input type="date" id="picker-add-libur" class="border rounded px-2 py-1 w-full mb-2">
      <div id="picker-libur-list" class="flex flex-wrap gap-2 mb-2"></div>
      <div class="flex gap-2 justify-end">
        <button id="picker-btn-ok" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">OK</button>
        <button id="picker-btn-cancel" class="px-3 py-1 bg-gray-400 text-white rounded hover:bg-gray-600 text-sm">Batal</button>
      </div>
    </div>
  </div>

  <script>
    // === Multi-date picker logic ===
    let liburTanggal = [];
    const liburInput = document.getElementById('libur-picker');
    const liburList = document.getElementById('libur-list');
    const modalLibur = document.getElementById('modal-libur');
    const pickerInput = document.getElementById('picker-add-libur');
    const pickerList = document.getElementById('picker-libur-list');
    const pickerBtnOK = document.getElementById('picker-btn-ok');
    const pickerBtnCancel = document.getElementById('picker-btn-cancel');

    function formatTanggal(dateStr, opts = {}) {
      // dateStr = '2025-06-25'
      const bulanID = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      const hariID = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const d = new Date(dateStr + "T00:00:00");
      if (opts.bulan) {
        return `${bulanID[d.getMonth()]} ${d.getFullYear()}`;
      }
      return `${hariID[d.getDay()]}, ${d.getDate()} ${bulanID[d.getMonth()]} ${d.getFullYear()}`;
    }

    function renderLiburList() {
      liburList.innerHTML = "";
      for (let d of liburTanggal.sort()) {
        const chip = document.createElement("span");
        chip.className = "px-2 py-0.5 bg-gray-200 rounded text-xs flex items-center gap-1";
        chip.innerText = formatTanggal(d);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.innerHTML = "&times;";
        btn.className = "ml-1 text-gray-500 hover:text-red-500";
        btn.onclick = () => {
          liburTanggal = liburTanggal.filter(x => x !== d);
          renderLiburList();
        };
        chip.appendChild(btn);
        liburList.appendChild(chip);
      }
      liburInput.value = liburTanggal.length ? `${liburTanggal.length} tanggal dipilih` : "";
    }

    liburInput.addEventListener("click", () => {
      // Show modal
      pickerInput.value = "";
      pickerList.innerHTML = "";
      for (let d of liburTanggal.sort()) {
        const chip = document.createElement("span");
        chip.className = "px-2 py-0.5 bg-gray-200 rounded text-xs flex items-center gap-1";
        chip.innerText = formatTanggal(d);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.innerHTML = "&times;";
        btn.className = "ml-1 text-gray-500 hover:text-red-500";
        btn.onclick = () => {
          liburTanggal = liburTanggal.filter(x => x !== d);
          pickerList.removeChild(chip);
        };
        chip.appendChild(btn);
        pickerList.appendChild(chip);
      }
      modalLibur.classList.remove("hidden");
    });
    pickerBtnOK.onclick = () => {
      renderLiburList();
      modalLibur.classList.add("hidden");
    };
    pickerBtnCancel.onclick = () => {
      modalLibur.classList.add("hidden");
    };
    pickerInput.addEventListener("change", () => {
      const val = pickerInput.value;
      if (val && !liburTanggal.includes(val)) {
        liburTanggal.push(val);
        const chip = document.createElement("span");
        chip.className = "px-2 py-0.5 bg-gray-200 rounded text-xs flex items-center gap-1";
        chip.innerText = formatTanggal(val);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.innerHTML = "&times;";
        btn.className = "ml-1 text-gray-500 hover:text-red-500";
        btn.onclick = () => {
          liburTanggal = liburTanggal.filter(x => x !== val);
          pickerList.removeChild(chip);
        };
        chip.appendChild(btn);
        pickerList.appendChild(chip);
      }
      pickerInput.value = "";
    });

    // === Import TXT logic ===
    document.getElementById('btn-import').onclick = () => {
      document.getElementById('import-txt').click();
    };
    document.getElementById('import-txt').addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return;
      document.getElementById('import-label').innerText = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('daftar-regu').value = e.target.result.replace(/\r/g, '').trim();
      };
      reader.readAsText(file);
    });

    // === Main Form Logic ===
    document.getElementById('schedule-form').onsubmit = function(e) {
      e.preventDefault();
      // Collect input
      const tglMulai = document.getElementById('tanggal-mulai').value;
      const tglSelesai = document.getElementById('tanggal-selesai').value;
      let regu = document.getElementById('daftar-regu').value.split('\n').map(x => x.trim()).filter(x => x);
      const urutan = document.querySelector('input[name=urutan]:checked').value;
      if (regu.length < 2) { alert("Minimal 2 regu."); return; }
      if (!tglMulai || !tglSelesai) { alert("Isi tanggal mulai & selesai."); return; }
      if (new Date(tglSelesai)<new Date(tglMulai)) { alert("Tanggal selesai harus >= mulai."); return;}
      showOutputPanel();
      generateSchedule({
        tglMulai: tglMulai,
        tglSelesai: tglSelesai,
        regu: regu,
        urutan: urutan,
        liburTanggal: [...liburTanggal]
      });
    };

    document.getElementById('btn-reset').onclick = function() {
      document.getElementById('output-panel').classList.add('hidden');
      document.getElementById('config-panel').classList.remove('hidden');
      document.getElementById('jadwal-tabel').innerHTML = "";
    };

    function showOutputPanel() {
      document.getElementById('output-panel').classList.remove('hidden');
      document.getElementById('config-panel').classList.add('hidden');
      window.scrollTo(0,0);
    }

    // === Penjadwalan ===
    function generateSchedule({tglMulai, tglSelesai, regu, urutan, liburTanggal}) {
      // 1. Generate array tanggal
      let tglList = [];
      let cur = new Date(tglMulai);
      let end = new Date(tglSelesai);
      while (cur <= end) {
        const ymd = cur.toISOString().slice(0,10);
        tglList.push(ymd);
        cur.setDate(cur.getDate() + 1);
      }
      // 2. Jadwalkan
      let jadwal = [];
      let liburSet = new Set(liburTanggal);
      let pool = regu.slice();
      let idx = 0;
      let prev = [];
      let cycleCount = 0;
      let shuffle = (arr) => {
        // Fisher-Yates
        let a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          let j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      };
      let poolHistory = [];
      for (let hari of tglList) {
        if (liburSet.has(hari)) {
          jadwal.push({tanggal: hari, grup1: "Libur", grup2: "Libur", isLibur: true});
          prev = [];
          continue;
        }
        let g1, g2;
        if (urutan === "acak") {
          // Shuffle pool if habis siklus
          if (idx >= pool.length) {
            pool = shuffle(regu);
            idx = 0;
            cycleCount++;
          }
          // Pilih dua grup, tidak sama dengan kemarin
          let available = pool.slice(idx).concat(pool.slice(0,idx));
          let tryCount = 0;
          do {
            if (idx + 2 > pool.length) {
              // At end, wrap
              pool = shuffle(regu);
              idx = 0;
              available = pool.slice(idx);
            }
            g1 = pool[idx % pool.length];
            g2 = pool[(idx + 1) % pool.length];
            idx += 2;
            tryCount++;
            // Hindari duplikat hari sebelumnya
          } while ((prev.includes(g1) || g1 === g2) && tryCount < 10*regu.length);

          jadwal.push({tanggal: hari, grup1: g1, grup2: g2, isLibur: false});
          prev = [g1,g2];
        } else {
          // Manual urutan, no acak
          g1 = regu[idx % regu.length];
          g2 = regu[(idx+1) % regu.length];
          if (g1 === prev[0]) idx++;
          jadwal.push({tanggal: hari, grup1: g1, grup2: g2, isLibur: false});
          prev = [g1,g2];
          idx += 2;
        }
      }
      renderJadwalTable(jadwal);
      // For download
      window._jadwalExport = jadwal;
    }

    // === Rendering Tabel Jadwal ===
    function renderJadwalTable(jadwal) {
      // Group by bulan
      let byBulan = {};
      for (let row of jadwal) {
        let blnKey = row.tanggal.slice(0,7); // '2025-06'
        if (!byBulan[blnKey]) byBulan[blnKey] = [];
        byBulan[blnKey].push(row);
      }
      // Render each month as a panel
      let container = document.getElementById('jadwal-tabel');
      container.innerHTML = "";
      for (let blnKey of Object.keys(byBulan)) {
        let rows = byBulan[blnKey];
        // Split to columns of 15 rows
        let columns = [];
        for (let i=0; i<rows.length; i+=15) {
          columns.push(rows.slice(i, i+15));
        }
        // Panel
        let panel = document.createElement('div');
        panel.className = "bg-white rounded shadow p-2 mb-4 flex flex-col gap-2 min-w-[330px] max-w-[370px] flex-1";
        // Sticky month header
        let monthHeader = document.createElement('div');
        monthHeader.className = "sticky-month text-center text-base font-bold mb-1 py-1 border-b border-slate-200 bg-slate-100";
        monthHeader.innerText = formatTanggal(blnKey + "-01", {bulan:true});
        panel.appendChild(monthHeader);
        // Columns
        let colsDiv = document.createElement('div');
        colsDiv.className = "flex flex-row gap-2";
        for (let col of columns) {
          let tbl = document.createElement('table');
          tbl.className = "border border-gray-300 min-w-[300px] mb-2";
          tbl.innerHTML = `
            <thead class="sticky-top">
              <tr>
                <th rowspan="2" class="bg-slate-100 border border-gray-300">Tanggal</th>
                <th colspan="2" class="bg-slate-100 border border-gray-300">Kelompok Jaga</th>
              </tr>
              <tr>
                <th class="bg-slate-100 border border-gray-300">Grup 1</th>
                <th class="bg-slate-100 border border-gray-300">Grup 2</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          let tbody = tbl.querySelector('tbody');
          for (let row of col) {
            let tr = document.createElement('tr');
            if (row.isLibur) {
              tr.className = "bg-gray-200";
              tr.innerHTML = `<td class="border border-gray-200">${formatTanggal(row.tanggal)}</td>
                              <td class="border border-gray-200 text-center" colspan="2">Libur</td>`;
            } else {
              tr.innerHTML = `<td class="border border-gray-200">${formatTanggal(row.tanggal)}</td>
                              <td class="border border-gray-200">${row.grup1}</td>
                              <td class="border border-gray-200">${row.grup2}</td>`;
            }
            tbody.appendChild(tr);
          }
          colsDiv.appendChild(tbl);
        }
        panel.appendChild(colsDiv);
        container.appendChild(panel);
      }
    }

    // === Export (SheetJS) ===
    function jadwalToSheet(jadwal) {
      // Returns array of arrays
      let data = [["Tanggal", "Grup 1", "Grup 2"]];
      for (let row of jadwal) {
        if (row.isLibur) {
          data.push([formatTanggal(row.tanggal), "Libur", "Libur"]);
        } else {
          data.push([formatTanggal(row.tanggal), row.grup1, row.grup2]);
        }
      }
      return data;
    }
    document.getElementById('btn-xlsx').onclick = function() {
      let jadwal = window._jadwalExport || [];
      let ws_data = jadwalToSheet(jadwal);
      let ws = XLSX.utils.aoa_to_sheet(ws_data);
      let wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Jadwal");
      XLSX.writeFile(wb, "jadwal.xlsx");
    };
    document.getElementById('btn-csv').onclick = function() {
      let jadwal = window._jadwalExport || [];
      let ws_data = jadwalToSheet(jadwal);
      let ws = XLSX.utils.aoa_to_sheet(ws_data);
      let csv = XLSX.utils.sheet_to_csv(ws, {FS:","});
      let blob = new Blob([csv],{type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href = url;
      a.download = "jadwal.csv";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url),500);
    };

    document.getElementById('btn-print').onclick = function() {
      window.print();
    };

    // === Autofill sample for easier demo (optional, can remove for prod) ===
    if (window.location.hostname === "localhost" || window.location.hostname.endsWith('github.io')) {
      document.getElementById('tanggal-mulai').value = new Date().toISOString().slice(0,10);
      let dt = new Date();
      dt.setDate(dt.getDate()+29);
      document.getElementById('tanggal-selesai').value = dt.toISOString().slice(0,10);
      document.getElementById('daftar-regu').value = "Regu A\nRegu B\nRegu C\nRegu D\nRegu E";
    }
  </script>
</body>
</html>
